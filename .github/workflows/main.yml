name: CI
on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      arch:
        description: 'Architecture to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - x64
          - x86
          - arm
      simd:
        description: 'SIMD instruction set for x64 builds (all builds all variants)'
        required: true
        default: 'avx'
        type: choice
        options:
          - all
          - sse3
          - avx
          - avx2
          - avx512
      artifact_id:
        description: 'Artifact ID to resume from (leave empty for fresh build)'
        required: false
        default: ''
        type: string
      create_release:
        description: 'Create a release after build completes'
        required: true
        default: false
        type: boolean
jobs:
  # SSE3 build (default compatibility build)
  build-x64-sse3:
    if: ${{ (github.event_name == 'push' || github.event.inputs.arch == 'all' || github.event.inputs.arch == 'x64') && (github.event.inputs.simd == 'all' || github.event.inputs.simd == 'sse3' || github.event.inputs.simd == '') }}
    runs-on: windows-2022
    permissions:
      contents: read
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Init
        run: Copy-Item -Path . -Destination "C:\ungoogled-chromium-windows" -Recurse
      - name: Setup Stage
        run: npm install
        working-directory: ./.github/actions/stage
      - name: Run Stage
        id: stage
        uses: ./.github/actions/stage
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          finished: false
          from_artifact: true
          simd: sse3
          artifact_id: ${{ github.event.inputs.artifact_id }}
    outputs:
      finished: ${{ steps.stage.outputs.finished }}
      artifact_id: ${{ steps.stage.outputs.artifact_id }}

  # AVX build (Sandy Bridge/Bulldozer or newer)
  build-x64-avx:
    if: ${{ (github.event_name == 'push' || github.event.inputs.arch == 'all' || github.event.inputs.arch == 'x64') && (github.event.inputs.simd == 'all' || github.event.inputs.simd == 'avx') }}
    runs-on: windows-2022
    permissions:
      contents: read
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Init
        run: Copy-Item -Path . -Destination "C:\ungoogled-chromium-windows" -Recurse
      - name: Setup Stage
        run: npm install
        working-directory: ./.github/actions/stage
      - name: Run Stage
        id: stage
        uses: ./.github/actions/stage
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          finished: false
          from_artifact: true
          simd: avx
          artifact_id: ${{ github.event.inputs.artifact_id }}
    outputs:
      finished: ${{ steps.stage.outputs.finished }}
      artifact_id: ${{ steps.stage.outputs.artifact_id }}

  # AVX2 build (Haswell/Excavator or newer)
  build-x64-avx2:
    if: ${{ (github.event_name == 'push' || github.event.inputs.arch == 'all' || github.event.inputs.arch == 'x64') && (github.event.inputs.simd == 'all' || github.event.inputs.simd == 'avx2') }}
    runs-on: windows-2022
    permissions:
      contents: read
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Init
        run: Copy-Item -Path . -Destination "C:\ungoogled-chromium-windows" -Recurse
      - name: Setup Stage
        run: npm install
        working-directory: ./.github/actions/stage
      - name: Run Stage
        id: stage
        uses: ./.github/actions/stage
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          finished: false
          from_artifact: true
          simd: avx2
          artifact_id: ${{ github.event.inputs.artifact_id }}
    outputs:
      finished: ${{ steps.stage.outputs.finished }}
      artifact_id: ${{ steps.stage.outputs.artifact_id }}

  # AVX512 build (Skylake-X/Zen 4 or newer)
  build-x64-avx512:
    if: ${{ (github.event_name == 'push' || github.event.inputs.arch == 'all' || github.event.inputs.arch == 'x64') && (github.event.inputs.simd == 'all' || github.event.inputs.simd == 'avx512') }}
    runs-on: windows-2022
    permissions:
      contents: read
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Init
        run: Copy-Item -Path . -Destination "C:\ungoogled-chromium-windows" -Recurse
      - name: Setup Stage
        run: npm install
        working-directory: ./.github/actions/stage
      - name: Run Stage
        id: stage
        uses: ./.github/actions/stage
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          finished: false
          from_artifact: true
          simd: avx512
          artifact_id: ${{ github.event.inputs.artifact_id }}
    outputs:
      finished: ${{ steps.stage.outputs.finished }}
      artifact_id: ${{ steps.stage.outputs.artifact_id }}

  build-x86:
    if: ${{ github.event_name == 'push' || github.event.inputs.arch == 'all' || github.event.inputs.arch == 'x86' }}
    runs-on: windows-2022
    permissions:
      contents: read
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Init
        run: Copy-Item -Path . -Destination "C:\ungoogled-chromium-windows" -Recurse
      - name: Setup Stage
        run: npm install
        working-directory: ./.github/actions/stage
      - name: Run Stage
        id: stage
        uses: ./.github/actions/stage
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          finished: false
          from_artifact: true
          x86: true
          artifact_id: ${{ github.event.inputs.artifact_id }}
    outputs:
      finished: ${{ steps.stage.outputs.finished }}
      artifact_id: ${{ steps.stage.outputs.artifact_id }}

  build-arm:
    if: ${{ github.event_name == 'push' || github.event.inputs.arch == 'all' || github.event.inputs.arch == 'arm' }}
    runs-on: windows-2022
    permissions:
      contents: read
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Init
        run: Copy-Item -Path . -Destination "C:\ungoogled-chromium-windows" -Recurse
      - name: Setup Stage
        run: npm install
        working-directory: ./.github/actions/stage
      - name: Run Stage
        id: stage
        uses: ./.github/actions/stage
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          finished: false
          from_artifact: true
          arm: true
          artifact_id: ${{ github.event.inputs.artifact_id }}
    outputs:
      finished: ${{ steps.stage.outputs.finished }}
      artifact_id: ${{ steps.stage.outputs.artifact_id }}

  publish-release:
    needs: [build-x64-sse3, build-x64-avx, build-x64-avx2, build-x64-avx512, build-x86, build-arm]
    if: ${{ always() && (github.event_name == 'push' || inputs.create_release) }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download x64-sse3 package
        if: ${{ needs.build-x64-sse3.result == 'success' && needs.build-x64-sse3.outputs.finished == 'true' }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: chromium-x64-sse3
      - name: Download x64-avx package
        if: ${{ needs.build-x64-avx.result == 'success' && needs.build-x64-avx.outputs.finished == 'true' }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: chromium-x64-avx
      - name: Download x64-avx2 package
        if: ${{ needs.build-x64-avx2.result == 'success' && needs.build-x64-avx2.outputs.finished == 'true' }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: chromium-x64-avx2
      - name: Download x64-avx512 package
        if: ${{ needs.build-x64-avx512.result == 'success' && needs.build-x64-avx512.outputs.finished == 'true' }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: chromium-x64-avx512
      - name: Download x86 package
        if: ${{ needs.build-x86.result == 'success' && needs.build-x86.outputs.finished == 'true' }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: chromium-x86
      - name: Download arm package
        if: ${{ needs.build-arm.result == 'success' && needs.build-arm.outputs.finished == 'true' }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: chromium-arm
      - name: Publish release
        id: publish
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          
          # Check if release exists, create if not
          if ! gh release view "$TAG" > /dev/null 2>&1; then
            echo "Creating release $TAG..."
            gh release create "$TAG" --title "$TAG" --notes "Ungoogled Chromium $TAG"
          fi
          
          # Upload any ungoogled-chromium files that exist
          files=()
          for f in ungoogled-chromium*; do
            [ -e "$f" ] && files+=("$f")
          done
          
          if [ ${#files[@]} -gt 0 ]; then
            echo "Uploading ${#files[@]} file(s)..."
            for file in "${files[@]}"; do
              echo "Uploading $file..."
              if ! gh release upload "$TAG" "$file" --clobber; then
                echo "Warning: Failed to upload $file, continuing..."
              fi
            done
          else
            echo "No ungoogled-chromium files found to upload"
          fi
          
          # Get release assets as JSON for output (with retry)
          for i in 1 2 3; do
            ASSETS=$(gh release view "$TAG" --json assets -q '.assets' 2>/dev/null) && break
            echo "Attempt $i: Failed to get release assets, retrying..."
            sleep 2
          done
          echo "assets=${ASSETS:-[]}" >> $GITHUB_OUTPUT
    outputs:
      assets: ${{ steps.publish.outputs.assets }}

  publish-winget:
    needs: publish-release
    if: ${{ github.event_name == 'push' || inputs.create_release }}
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          cache: 'npm'
          cache-dependency-path: ./.github/actions/winget/package.json
      - name: Setup Stage
        run: npm install
        working-directory: ./.github/actions/winget
      - name: Run Stage
        id: stage
        uses: ./.github/actions/winget
        with:
          token: ${{ secrets.PAT }}
          version: ${{ github.ref_name }}
          assets: ${{ needs.publish-release.outputs.assets }}
